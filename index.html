<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLACKBRIAR // CONNECTED</title>
    <style>
        /* --- ESTILO VISUAL (Cyberpunk / CIA) --- */
        :root {
            --bg: #050505;
            --panel: #111;
            --text: #aaa;
            --accent: #00e676; /* Verde Neon */
            --alert: #d50000;   /* Vermelho Sangue */
            --guide: #00b0ff;   /* Azul Cipher */
            --font: 'Courier New', monospace;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: var(--font); margin: 0; height: 100vh;
            overflow: hidden; display: flex; flex-direction: column;
        }

        /* Scanlines */
        body::after {
            content: " "; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.15) 50%);
            background-size: 100% 3px; pointer-events: none; z-index: 99;
        }

        /* --- TELA LOBBY --- */
        #lobby-screen {
            display: flex; flex-direction: column; height: 100%; padding: 15px;
            background: radial-gradient(circle, #1a1a1a 0%, #000 90%);
        }

        header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid var(--accent); padding-bottom: 10px; }
        h1 { margin: 0; color: #fff; letter-spacing: 4px; }
        .status { font-size: 10px; color: var(--accent); animation: blink 2s infinite; }

        .user-setup { 
            display: flex; justify-content: center; align-items: center; gap: 10px; 
            margin-bottom: 10px; background: #080808; padding: 5px; border: 1px solid #333;
        }
        .lbl { font-size: 11px; font-weight: bold; color: var(--guide); }
        #nick-in {
            background: #000; border: 1px solid #444; color: #fff;
            padding: 5px; font-family: var(--font); width: 120px; text-align: center; outline: none;
        }

        #chat-box {
            flex-grow: 1; background: var(--panel); border: 1px solid #333;
            display: flex; flex-direction: column; overflow: hidden; margin-bottom: 15px;
            box-shadow: inset 0 0 20px #000;
        }
        #chat-msgs { flex-grow: 1; overflow-y: auto; padding: 15px; font-size: 13px; }
        
        .msg { margin-bottom: 6px; line-height: 1.4; border-left: 2px solid transparent; padding-left: 5px; }
        .time { color: #444; font-size: 10px; margin-right: 5px; }
        
        /* Cores de Cargos */
        .role-cipher { color: var(--guide); border-left-color: var(--guide); }
        .role-sys { color: #555; font-style: italic; } 
        .role-me { color: var(--accent); }
        .role-other { color: #ddd; }

        #chat-controls { display: flex; border-top: 1px solid #333; padding: 10px; background: #000; }
        #chat-txt { flex-grow: 1; background: transparent; border: none; color: #fff; outline: none; font-family: var(--font); font-size: 14px; }
        #chat-send { background: #222; color: #fff; border: 1px solid #444; padding: 5px 20px; cursor: pointer; font-family: var(--font); }

        #action-btn {
            background: #111; color: #555; border: 1px solid #333; padding: 15px;
            font-size: 16px; font-family: var(--font); font-weight: bold;
            cursor: not-allowed; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
        }
        #action-btn.ready { background: var(--alert); color: white; cursor: pointer; border-color: var(--alert); }
        #action-btn.resume { background: var(--accent); color: #000; border-color: var(--accent); }

        /* --- TELA JOGO --- */
        #game-screen { display: none; flex-direction: column; height: 100%; }
        #trace-wrap { width: 100%; height: 5px; background: #222; }
        #trace-fill { width: 0%; height: 100%; background: var(--alert); transition: width 0.2s linear; }
        #term-out { flex-grow: 1; padding: 10px; overflow-y: auto; }
        .ln { margin-bottom: 2px; white-space: pre-wrap; font-size: 13px; line-height: 1.3; }
        .err { color: var(--alert); } .suc { color: var(--accent); } .inf { color: var(--guide); }
        #term-in-area { display: flex; padding: 10px; background: #111; border-top: 1px solid #333; }
        #prompt { color: var(--accent); margin-right: 8px; font-weight: bold; }
        #cmd { flex-grow: 1; background: transparent; border: none; color: #fff; outline: none; font-family: var(--font); font-size: 14px; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <header>
            <h1>BLACKBRIAR</h1>
            <div class="status">FIREBASE LINK: ACTIVE</div>
        </header>

        <div class="user-setup">
            <span class="lbl">CODINOME:</span>
            <input type="text" id="nick-in" placeholder="Digite..." maxlength="12">
        </div>

        <div id="chat-box">
            <div id="chat-msgs"></div>
            <div id="chat-controls">
                <input type="text" id="chat-txt" placeholder="Mensagem / 'apply'..." autocomplete="off">
                <button id="chat-send">ENVIAR</button>
            </div>
        </div>

        <button id="action-btn" disabled onclick="window.App.startGame()">AGUARDANDO 'APPLY'...</button>
    </div>

    <div id="game-screen">
        <div id="trace-wrap"><div id="trace-fill"></div></div>
        <div id="term-out"></div>
        <div id="term-in-area">
            <span id="prompt">guest@node:~$</span>
            <input type="text" id="cmd" autocomplete="off" spellcheck="false">
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // SUAS CHAVES REAIS
    const firebaseConfig = {
      apiKey: "AIzaSyC32KYvQh8IwTDIs-YVhUdPP2Tu4oAyhP4",
      authDomain: "blackbriar-server.firebaseapp.com",
      databaseURL: "https://blackbriar-server-default-rtdb.firebaseio.com",
      projectId: "blackbriar-server",
      storageBucket: "blackbriar-server.firebasestorage.app",
      messagingSenderId: "849295204914",
      appId: "1:849295204914:web:aca6c7ffbc7ff9fe84522b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, 'global_chat');

    // Bridge para conectar o módulo ao resto do jogo
    window.Cloud = {
        send: function(user, text, isSys = false) {
            push(chatRef, {
                u: user,
                t: text,
                s: isSys,
                ts: Date.now()
            });
        }
    };

    // Ouvinte de Novas Mensagens
    onChildAdded(chatRef, (snapshot) => {
        const data = snapshot.val();
        let role = "role-other";
        if (data.s) role = "role-cipher"; // Sistema/Cipher
        else if (data.u === window.App.user) role = "role-me"; // Eu

        // Chama a função visual
        window.Chat.uiAdd(data.u, data.t, role);
    });
</script>

<script>
    // --- APP PRINCIPAL ---
    window.App = {
        user: "Guest",
        identified: false,
        state: "idle", // idle, running, paused

        init: function() {
            // Mensagens tutoriais locais (só pra você)
            setTimeout(() => Chat.uiAdd("Cipher", "Conexão segura estabelecida.", "role-cipher"), 500);
            setTimeout(() => Chat.uiAdd("Cipher", "Para entrar na operação, digite seu CODINOME acima e envie 'apply' no chat.", "role-cipher"), 1500);
        },

        applyIdentity: function() {
            const el = document.getElementById('nick-in');
            const val = el.value.trim();
            if(val.length < 3) {
                Chat.uiAdd("Cipher", "Erro: Codinome muito curto.", "role-cipher");
                return;
            }
            
            this.user = val;
            this.identified = true;
            
            // Trava UI
            el.disabled = true;
            el.style.borderColor = "#00e676";
            
            // Habilita Botão
            const btn = document.getElementById('action-btn');
            btn.disabled = false;
            btn.innerText = "INICIAR OPERAÇÃO";
            btn.classList.add('ready');

            // Avisa no Chat Global
            if(window.Cloud) window.Cloud.send("SYSTEM", `Agente [${this.user}] conectou-se ao Gateway.`, true);
        },

        startGame: function() {
            if(this.state === "idle") {
                Game.init();
                Term.boot();
                this.screen('game');
                this.state = "running";
            } else if (this.state === "paused") {
                this.screen('game');
                Game.paused = false;
                this.state = "running";
                Term.print(">> RETOMANDO CONEXÃO...", "inf");
            }
        },

        pause: function() {
            if(this.state !== "running") return;
            Game.paused = true;
            this.state = "paused";
            this.screen('lobby');
            
            const btn = document.getElementById('action-btn');
            btn.innerText = "CONTINUAR MISSÃO";
            btn.classList.add('resume');
        },

        reset: function() {
            this.state = "idle";
            this.screen('lobby');
            const btn = document.getElementById('action-btn');
            btn.innerText = "INICIAR OPERAÇÃO";
            btn.classList.remove('resume');
        },

        screen: function(name) {
            document.getElementById('lobby-screen').style.display = name==='lobby'?'flex':'none';
            document.getElementById('game-screen').style.display = name==='game'?'flex':'none';
        }
    };

    // --- CHAT VISUAL ---
    window.Chat = {
        init: function() {
            const btn = document.getElementById('chat-send');
            const inp = document.getElementById('chat-txt');
            
            const action = () => {
                const txt = inp.value.trim();
                if(!txt) return;

                if(txt.toLowerCase() === 'apply') {
                    if(window.App.identified) this.uiAdd("Cipher", "Identidade já confirmada.", "role-cipher");
                    else window.App.applyIdentity();
                } else {
                    // Envia para Firebase
                    const sender = window.App.identified ? window.App.user : "Anônimo";
                    if(window.Cloud) window.Cloud.send(sender, txt);
                }
                inp.value = '';
            };

            btn.onclick = action;
            inp.onkeydown = (e) => { if(e.key === 'Enter') action(); };
        },

        uiAdd: function(name, txt, cls) {
            const box = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = `msg ${cls}`;
            const t = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            div.innerHTML = `<span class="time">[${t}]</span> <b>${name}:</b> ${txt}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    };

    // --- JOGO (BLACKBRIAR) ---
    const Game = {
        trace: 0, paused: false, seed: 0, timer: null,
        init: function() {
            this.trace = 0; this.paused = false;
            let s = navigator.userAgent + screen.width;
            let h=0xdeadbeef; for(let i=0;i<s.length;i++)h=Math.imul(h^s.charCodeAt(i),2654435761);
            this.seed = h>>>0;
            
            if(this.timer) clearInterval(this.timer);
            this.timer = setInterval(() => {
                if(this.paused) return;
                this.trace += 0.05;
                document.getElementById('trace-fill').style.width = this.trace+"%";
                if(this.trace>=100) { clearInterval(this.timer); Term.bsod(); }
            }, 100);
            FS.build(this.seed);
        },
        penalty: function(v) { this.trace+=v; Term.print(`[!] TRACE LEVEL UP (+${v}%)`, "err"); },
        rnd: function(){this.seed=(this.seed*9301+49297)%233280;return this.seed/233280;},
        rHex: function(l){let s="";for(let i=0;i<l;i++)s+=Math.floor(this.rnd()*16).toString(16).toUpperCase();return s;}
    };

    const FS = {
        tree:{}, path:[], rootP:"", key:"",
        build: function(s) {
            this.path=[]; this.rootP="R"+Game.rHex(3)+"X"; this.key=Game.rHex(6);
            let noise=""; for(let i=0;i<120;i++) noise+=`[LOG] Process ID ${Math.floor(Math.random()*9999)} OK.\n`;
            noise+=`[CRIT] ROOT PASS DUMP: '${this.rootP}'\n`;
            for(let i=0;i<120;i++) noise+=`[LOG] Port ${Math.floor(Math.random()*80)} closed.\n`;

            this.tree = {
                "root":{type:"dir", k:{
                    "var":{type:"dir", k:{
                        "log":{type:"dir", k:{
                            "syslog":{type:"file", txt:noise},
                            "auth.log":{type:"file", lock:true, txt:"Access Denied."}
                        }}
                    }},
                    "home":{type:"dir", k:{
                        "guest":{type:"dir", k:{
                            "mission.txt":{type:"file", txt:"OBJETIVO: Pegar 'PAYLOAD.bin'.\n1. Ache a senha de root no 'syslog' usando grep.\n2. Vire root (sudo).\n3. Pegue a chave no 'secret.conf'."}
                        }}
                    }},
                    "PAYLOAD.bin":{type:"file", enc:true, k:this.key, txt:`\n$$$ VITORIA $$$\nTOKEN: ${s}-${this.key}\n`},
                    "secret.conf":{type:"file", lock:true, txt:`KEY: ${this.key}`}
                }}
            };
        },
        get: function(){
            let c=this.tree["root"];
            for(let p of this.path){if(c.k&&c.k[p])c=c.k[p];else return null;}
            return c;
        }
    };

    const Term = {
        div: document.getElementById('term-out'),
        in: document.getElementById('cmd'),
        prm: document.getElementById('prompt'),
        state: null, root: false, tgt: null,

        boot: function() {
            this.div.innerHTML=""; this.root=false; this.state=null;
            this.print("BLACKBRIAR KERNEL v7.1 - ONLINE");
            this.print("Digite 'chat' para pausar.", "inf");
            this.upd(); this.in.value=""; this.in.focus();
            this.in.onkeydown=(e)=>{if(e.key==='Enter')this.run();};
            document.getElementById('game-screen').onclick=()=>this.in.focus();
        },
        print: function(t,c=''){ this.div.innerHTML+=`<div class="ln ${c}">${t}</div>`; this.div.scrollTop=this.div.scrollHeight; },
        upd: function(){
            const u=this.root?"root":window.App.user; const s=this.root?"#":"$";
            const p=FS.path.length?"/"+FS.path.join("/"):"~";
            this.prm.innerText=`${u}@node-33:${p}${s}`;
            this.prm.style.color=this.root?"var(--alert)":"var(--accent)";
        },
        bsod: function(){
            window.App.reset();
            alert("GAME OVER\nRastreado.");
            if(window.Cloud) window.Cloud.send("SYSTEM", `Sinal do agente ${window.App.user} perdido.`, true);
        },
        run: function(){
            const r=this.in.value; this.in.value="";
            if(this.state){this.pass(r);return;}
            if(!r.trim())return;
            this.print(this.prm.innerText+" "+r, "inf");
            const a=r.trim().split(' ');
            
            if(a[0]==="chat"||a[0]==="lobby"){window.App.pause();return;}

            switch(a[0]){
                case 'help': this.print("ls, cd, cat, grep, sudo, pwd, clear, chat"); break;
                case 'clear': this.div.innerHTML=""; break;
                case 'pwd': this.print("/root/"+FS.path.join("/")); break;
                case 'ls':
                    const d=FS.get(); if(!d)return;
                    let o=[]; for(let k in d.k){
                        let i=d.k[k], c=i.type==='dir'?'dir':'';
                        if(i.lock||i.enc)c+=' err'; o.push(`<span class="${c}">${k}</span>`);
                    }
                    this.print(o.join('  ')); break;
                case 'cd':
                    if(a[1]===".."){if(FS.path.length)FS.path.pop();}
                    else if(a[1]){
                        const n=FS.get();
                        if(n.k[a[1]]&&n.k[a[1]].type==='dir')FS.path.push(a[1]);
                        else{this.print("Erro.", "err");Game.penalty(2);}
                    } break;
                case 'cat':
                    if(!a[1])return; const f=FS.get().k[a[1]];
                    if(!f||f.type!=='file')return this.print("Erro.", "err");
                    if(f.lock&&!this.root){this.print("Negado.", "err");Game.penalty(5);return;}
                    if(f.enc){this.print("Chave:", "inf");this.state='dec';this.tgt=f;return;}
                    this.print(f.txt); break;
                case 'grep':
                    if(!a[2])return this.print("grep [termo] [arq]");
                    const gf=FS.get().k[a[2]]; if(!gf)return;
                    let h=0, l=gf.txt.split('\n');
                    for(let x of l)if(x.includes(a[1])){this.print(x,"suc");h++;}
                    if(!h)this.print("0 resultados."); break;
                case 'sudo':
                    if(this.root)return this.print("Já é root.");
                    this.print("Senha:", "err");this.state='sudo'; break;
                default: this.print("Comando inválido.", "err");Game.penalty(2);
            }
            this.upd();
        },
        pass: function(v){
            if(this.state==='sudo'){
                if(v===FS.rootP){this.root=true;this.print("ROOT OK.","suc");Game.trace-=15;}
                else{this.print("Erro.","err");Game.penalty(10);}
            }else if(this.state==='dec'){
                if(v===FS.tgt.k){
                    this.print("SUCESSO:","suc");this.print(this.tgt.txt);
                    document.getElementById('trace-fill').style.background="#0f0";
                    setTimeout(()=>alert("MISSÃO CUMPRIDA!"),500);
                }else{this.print("Erro.","err");Game.penalty(15);}
            }
            this.state=null;this.upd();
        }
    };

    window.onload = function() {
        window.App.init();
        window.Chat.init();
    };
</script>
</body>
</html>
